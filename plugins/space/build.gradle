import static Versions.*

buildscript {
    repositories {
        maven { url "https://www.jetbrains.com/intellij-repository/snapshots" } // for nightly builds
        if (Build.buildSettings.useCacheRedirector) {
            maven { url "https://cache-redirector.jetbrains.com/jetbrains.bintray.com/intellij-plugin-service" }
        } else {
            maven { url "https://dl.bintray.com/jetbrains/intellij-plugin-service" }
        }
    }
}

plugins {
    id "org.jetbrains.intellij" version "0.4.13"
}

applyKotlinJVM()

if (hasProperty("teamcity")) {
    if (project.hasProperty('pluginChannel')) {
        version = "2020.1.internal.${teamcity["build.number"]}"
    } else {
        version = "2020.1.${teamcity["build.number"]}"
    }
}

dependencies {
    compile project(":app:app-state")

    compile "io.ktor:ktor-server-core:$ktor_version"
    compile "io.ktor:ktor-server-jetty:$ktor_version"
    compile "org.slf4j:jul-to-slf4j:$sl4j_version"
    compile "ch.qos.logback:logback-classic:1.2.1"

    compile "org.glassfish.jersey.core:jersey-common:2.23"
    compile "org.glassfish.jersey.core:jersey-client:2.23"

    compile "nl.komponents.kovenant:kovenant:3.3.0"
    compile "commons-io:commons-io:$apache_commons_io_version"

    compile "org.jetbrains.kotlin:kotlin-main-kts:$kotlin_version" // dep for pipelines-config-dsl-dependencies-resolve

    compile project(':plugins:pipelines:pipelines-config:pipelines-config-dsl-compile')
    compile project(':plugins:pipelines:pipelines-config:pipelines-config-dsl-script-exec')
    compile project(':plugins:pipelines:pipelines-config:pipelines-config-utils')
    compile project(":plugins:pipelines:pipelines-config:pipelines-config-dsl-dependencies-resolve")
    compile project(':plugins:pipelines:pipelines-common')

    compile project(':plugins:pipelines:pipelines-engine')
    compile project(':plugins:pipelines:pipelines-utils')
    compile project(':plugins:pipelines:pipelines-provider')
    compile project(':plugins:pipelines:pipelines-provider-local')
}

test { finalizedBy jacocoTestReport }

def kotlinIdeaPluginVersion = "1.3.70-release-IJ2020.1-2"

intellij {
    version "201.6668.121"
    pluginName "space-intellij-plugin"
    updateSinceUntilBuild false
    sandboxDirectory "${project.buildDir}/.sandbox"
    setPlugins("org.jetbrains.kotlin:$kotlinIdeaPluginVersion", 'git4idea')
    downloadSources = true
}

runIde {
    jbrVersion = '11_0_2b159'
}

publishPlugin {
    channels project.hasProperty('pluginChannel') ? project.property('pluginChannel') : ''
    token System.getenv('IDEA_PLUGIN_DEPLOY_TOKEN')
}

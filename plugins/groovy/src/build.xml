<!--
  ~ Copyright 2000-2007 JetBrains s.r.o.
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<project name="Generating the build of groovy language plugin" default="make.project">
  <property file="groovy.properties"/>
  <property name="project.dest" value="${project.dir}/classes/production/Groovy"/>
  <property name="idea.dir" value="${project.dest}/lib/idea"/>
  <property name="idea.lib" value="${project.dest}/lib/idea/lib"/>
  <property name="groovy.lib" value="${project.dir}/GDK"/>


  <path id="base.path">
    <fileset dir="${idea.lib}">
      <include name="**/*.jar"/>
    </fileset>
  </path>

  <path id="groovy.path">
    <fileset dir="${groovy.lib}">
      <include name="**/*.jar"/>
    </fileset>
  </path>

  <target name="unzip last successful IDEA build">
    <unzip dest="${idea.dir}">
      <fileset dir="${idea.pack}">
        <include name="*.zip"/>
      </fileset>
    </unzip>
  </target>


  <target name="clear.all" description="clears all files">
    <mkdir dir="${project.dest}"/>
    <delete includeemptydirs="true">
      <fileset dir="${project.dest}"/>
    </delete>
  </target>

  <target name="build.lexer" description="makes lexer file">
    <ant dir="org/jetbrains/plugins/groovy/lang/lexer/"
         antfile="build.xml" target="generate.lexer"/>
  </target>

  <target name="make.project" description="makes project" depends="build.lexer, unzip last successful IDEA build">
    <copy todir="${project.dest}/META-INF">
      <fileset dir="${project.dir}/META-INF"/>
    </copy>

    <copy todir="${project.dest}/resources">
      <fileset dir="${project.dir}/resources"/>
    </copy>

    <javac srcdir="."
           destdir="${project.dest}">
      <classpath refid="base.path"/>
      <classpath refid="groovy.path"/>
    </javac>
  </target>

  <target name="build.project" depends="clear.all, make.project" description="builds project"/>

  <target name="rebuild.all" depends="build.project, jar.groovy, zip.sources.groovy" description="builds and jar project and zip sources"/>

  <target name="jar.groovy" depends="make.project" description="makes groovy jar">
    <mkdir dir="${project.dir}/tempjar/Groovy/lib"/>

    <jar destfile="${project.dir}/tempjar/Groovy/lib/Groovy.jar">
      <fileset dir="${project.dest}" excludes="**/*build.xml, **/groovy.properties"/>
    </jar>

    <copy todir="${project.dir}/tempjar/Groovy/lib">
      <fileset dir="${groovy.lib}">
        <include name="**/*.jar"/>
      </fileset>
    </copy>

    <zip destfile="${project.dir}/Groovy.zip" basedir="${project.dir}/tempjar"/>

    <delete dir="${project.dir}/tempjar"/>
  </target>

  <target name="zip.sources.groovy" description="zips sources">
    <zip destfile="${project.dir}/sources.zip"
         basedir="${project.dir}"
         includes="src/**/*.java,
         src/**/*.properties,
         src/**/*.flex,
         src/**/*.jar,
         src/**/*.skeleton,
         src/**/*.xml,
         resources/**/*.png,
         META-INF/**/*.xml"
         excludes="src/**/*junit*"
        />
  </target>

</project>
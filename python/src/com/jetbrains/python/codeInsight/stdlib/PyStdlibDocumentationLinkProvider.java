/*
 * Copyright 2000-2014 JetBrains s.r.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.jetbrains.python.codeInsight.stdlib;

import com.google.common.collect.ImmutableMap;
import com.intellij.openapi.projectRoots.Sdk;
import com.intellij.openapi.util.text.StringUtil;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.psi.PsiElement;
import com.intellij.psi.PsiFileSystemItem;
import com.intellij.psi.PsiNamedElement;
import com.intellij.psi.util.QualifiedName;
import com.jetbrains.python.PyNames;
import com.jetbrains.python.documentation.PythonDocumentationLinkProvider;
import com.jetbrains.python.documentation.PythonDocumentationProvider;
import com.jetbrains.python.psi.PyClass;
import com.jetbrains.python.psi.PyFile;
import com.jetbrains.python.psi.PyFunction;
import com.jetbrains.python.psi.impl.PyBuiltinCache;
import com.jetbrains.python.psi.resolve.QualifiedNameFinder;
import com.jetbrains.python.sdk.PythonSdkType;

import java.util.Map;

/**
 * @author yole
 */
public class PyStdlibDocumentationLinkProvider implements PythonDocumentationLinkProvider {
  // use tools/stdlib-modindex.py to regenerate the map when new Python versions are released
  private static final Map<String, String> py2LibraryModulesToWebpageName = ImmutableMap.<String, String>builder()
    .put("BaseHTTPServer", "basehttpserver")
    .put("Bastion", "bastion")
    .put("CGIHTTPServer", "cgihttpserver")
    .put("ColorPicker", "colorpicker")
    .put("ConfigParser", "configparser")
    .put("Cookie", "cookie")
    .put("DocXMLRPCServer", "docxmlrpcserver")
    .put("EasyDialogs", "easydialogs")
    .put("FrameWork", "framework")
    .put("HTMLParser", "htmlparser")
    .put("MacOS", "macos")
    .put("MimeWriter", "mimewriter")
    .put("MiniAEFrame", "miniaeframe")
    .put("Queue", "queue")
    .put("ScrolledText", "scrolledtext")
    .put("SimpleHTTPServer", "simplehttpserver")
    .put("SimpleXMLRPCServer", "simplexmlrpcserver")
    .put("SocketServer", "socketserver")
    .put("StringIO", "stringio")
    .put("Tix", "tix")
    .put("Tkinter", "tkinter")
    .put("UserDict", "userdict")
    .put("__builtin__", "__builtin__")
    .put("__future__", "__future__")
    .put("__main__", "__main__")
    .put("_winreg", "_winreg")
    .put("abc", "abc")
    .put("aepack", "aepack")
    .put("aetools", "aetools")
    .put("aetypes", "aetypes")
    .put("aifc", "aifc")
    .put("al", "al")
    .put("anydbm", "anydbm")
    .put("argparse", "argparse")
    .put("array", "array")
    .put("ast", "ast")
    .put("asynchat", "asynchat")
    .put("asyncore", "asyncore")
    .put("atexit", "atexit")
    .put("audioop", "audioop")
    .put("autoGIL", "autogil")
    .put("base64", "base64")
    .put("bdb", "bdb")
    .put("binascii", "binascii")
    .put("binhex", "binhex")
    .put("bisect", "bisect")
    .put("bsddb", "bsddb")
    .put("bz2", "bz2")
    .put("calendar", "calendar")
    .put("cd", "cd")
    .put("cgi", "cgi")
    .put("cgitb", "cgitb")
    .put("chunk", "chunk")
    .put("cmath", "cmath")
    .put("cmd", "cmd")
    .put("code", "code")
    .put("codecs", "codecs")
    .put("codeop", "codeop")
    .put("collections", "collections")
    .put("colorsys", "colorsys")
    .put("commands", "commands")
    .put("compileall", "compileall")
    .put("contextlib", "contextlib")
    .put("cookielib", "cookielib")
    .put("copy", "copy")
    .put("copy_reg", "copy_reg")
    .put("crypt", "crypt")
    .put("csv", "csv")
    .put("ctypes", "ctypes")
    .put("curses", "curses")
    .put("curses.ascii", "curses.ascii")
    .put("curses.panel", "curses.panel")
    .put("datetime", "datetime")
    .put("dbhash", "dbhash")
    .put("dbm", "dbm")
    .put("decimal", "decimal")
    .put("difflib", "difflib")
    .put("dircache", "dircache")
    .put("dis", "dis")
    .put("distutils", "distutils")
    .put("dl", "dl")
    .put("doctest", "doctest")
    .put("dumbdbm", "dumbdbm")
    .put("dummy_thread", "dummy_thread")
    .put("dummy_threading", "dummy_threading")
    .put("email", "email")
    .put("email.charset", "email.charset")
    .put("email.encoders", "email.encoders")
    .put("email.errors", "email.errors")
    .put("email.generator", "email.generator")
    .put("email.header", "email.header")
    .put("email.iterators", "email.iterators")
    .put("email.message", "email.message")
    .put("email.mime", "email.mime")
    .put("email.parser", "email.parser")
    .put("email.utils", "email.util")
    .put("ensurepip", "ensurepip")
    .put("errno", "errno")
    .put("fcntl", "fcntl")
    .put("filecmp", "filecmp")
    .put("fileinput", "fileinput")
    .put("fl", "fl")
    .put("fm", "fm")
    .put("fnmatch", "fnmatch")
    .put("formatter", "formatter")
    .put("fpectl", "fpectl")
    .put("fpformat", "fpformat")
    .put("fractions", "fractions")
    .put("ftplib", "ftplib")
    .put("functools", "functools")
    .put("future_builtins", "future_builtins")
    .put("gc", "gc")
    .put("gdbm", "gdbm")
    .put("gensuitemodule", "gensuitemodule")
    .put("getopt", "getopt")
    .put("getpass", "getpass")
    .put("gettext", "gettext")
    .put("gl", "gl")
    .put("glob", "glob")
    .put("grp", "grp")
    .put("gzip", "gzip")
    .put("hashlib", "hashlib")
    .put("heapq", "heapq")
    .put("hmac", "hmac")
    .put("hotshot", "hotshot")
    .put("htmllib", "htmllib")
    .put("httplib", "httplib")
    .put("ic", "ic")
    .put("imageop", "imageop")
    .put("imaplib", "imaplib")
    .put("imgfile", "imgfile")
    .put("imghdr", "imghdr")
    .put("imp", "imp")
    .put("importlib", "importlib")
    .put("imputil", "imputil")
    .put("inspect", "inspect")
    .put("io", "io")
    .put("itertools", "itertools")
    .put("jpeg", "jpeg")
    .put("json", "json")
    .put("keyword", "keyword")
    .put("linecache", "linecache")
    .put("locale", "locale")
    .put("logging", "logging")
    .put("logging.config", "logging.config")
    .put("logging.handlers", "logging.handlers")
    .put("macostools", "macostools")
    .put("macpath", "macpath")
    .put("mailbox", "mailbox")
    .put("mailcap", "mailcap")
    .put("marshal", "marshal")
    .put("math", "math")
    .put("md5", "md5")
    .put("mhlib", "mhlib")
    .put("mimetools", "mimetools")
    .put("mimetypes", "mimetypes")
    .put("mimify", "mimify")
    .put("mmap", "mmap")
    .put("modulefinder", "modulefinder")
    .put("msilib", "msilib")
    .put("msvcrt", "msvcrt")
    .put("multifile", "multifile")
    .put("multiprocessing", "multiprocessing")
    .put("mutex", "mutex")
    .put("netrc", "netrc")
    .put("new", "new")
    .put("nis", "nis")
    .put("nntplib", "nntplib")
    .put("numbers", "numbers")
    .put("operator", "operator")
    .put("optparse", "optparse")
    .put("os", "os")
    .put("os.path", "os.path")
    .put("ossaudiodev", "ossaudiodev")
    .put("parser", "parser")
    .put("pdb", "pdb")
    .put("pickle", "pickle")
    .put("pickletools", "pickletools")
    .put("pipes", "pipes")
    .put("pkgutil", "pkgutil")
    .put("platform", "platform")
    .put("plistlib", "plistlib")
    .put("popen2", "popen2")
    .put("poplib", "poplib")
    .put("posix", "posix")
    .put("posixfile", "posixfile")
    .put("pprint", "pprint")
    .put("pty", "pty")
    .put("pwd", "pwd")
    .put("py_compile", "py_compile")
    .put("pyclbr", "pyclbr")
    .put("pydoc", "pydoc")
    .put("quopri", "quopri")
    .put("random", "random")
    .put("re", "re")
    .put("readline", "readline")
    .put("repr", "repr")
    .put("resource", "resource")
    .put("rexec", "rexec")
    .put("rfc822", "rfc822")
    .put("rlcompleter", "rlcompleter")
    .put("robotparser", "robotparser")
    .put("runpy", "runpy")
    .put("sched", "sched")
    .put("select", "select")
    .put("sets", "sets")
    .put("sgmllib", "sgmllib")
    .put("sha", "sha")
    .put("shelve", "shelve")
    .put("shlex", "shlex")
    .put("shutil", "shutil")
    .put("signal", "signal")
    .put("site", "site")
    .put("smtpd", "smtpd")
    .put("smtplib", "smtplib")
    .put("sndhdr", "sndhdr")
    .put("socket", "socket")
    .put("spwd", "spwd")
    .put("sqlite3", "sqlite3")
    .put("ssl", "ssl")
    .put("stat", "stat")
    .put("statvfs", "statvfs")
    .put("string", "string")
    .put("stringprep", "stringprep")
    .put("struct", "struct")
    .put("subprocess", "subprocess")
    .put("sunau", "sunau")
    .put("sunaudiodev", "sunaudio")
    .put("symbol", "symbol")
    .put("symtable", "symtable")
    .put("sys", "sys")
    .put("sysconfig", "sysconfig")
    .put("syslog", "syslog")
    .put("tabnanny", "tabnanny")
    .put("tarfile", "tarfile")
    .put("telnetlib", "telnetlib")
    .put("tempfile", "tempfile")
    .put("termios", "termios")
    .put("test", "test")
    .put("textwrap", "textwrap")
    .put("thread", "thread")
    .put("threading", "threading")
    .put("time", "time")
    .put("timeit", "timeit")
    .put("token", "token")
    .put("tokenize", "tokenize")
    .put("trace", "trace")
    .put("traceback", "traceback")
    .put("ttk", "ttk")
    .put("tty", "tty")
    .put("turtle", "turtle")
    .put("types", "types")
    .put("unicodedata", "unicodedata")
    .put("unittest", "unittest")
    .put("urllib", "urllib")
    .put("urllib2", "urllib2")
    .put("urlparse", "urlparse")
    .put("user", "user")
    .put("uu", "uu")
    .put("uuid", "uuid")
    .put("warnings", "warnings")
    .put("wave", "wave")
    .put("weakref", "weakref")
    .put("webbrowser", "webbrowser")
    .put("whichdb", "whichdb")
    .put("winsound", "winsound")
    .put("wsgiref", "wsgiref")
    .put("xdrlib", "xdrlib")
    .put("xml.dom", "xml.dom")
    .put("xml.dom.minidom", "xml.dom.minidom")
    .put("xml.dom.pulldom", "xml.dom.pulldom")
    .put("xml.etree.ElementTree", "xml.etree.elementtree")
    .put("xml.parsers.expat", "pyexpat")
    .put("xml.sax", "xml.sax")
    .put("xml.sax.handler", "xml.sax.handler")
    .put("xml.sax.saxutils", "xml.sax.utils")
    .put("xml.sax.xmlreader", "xml.sax.reader")
    .put("xmllib", "xmllib")
    .put("xmlrpclib", "xmlrpclib")
    .put("zipfile", "zipfile")
    .put("zipimport", "zipimport")
    .put("zlib", "zlib")
    .build();

  private static final Map<String, String> py3LibraryModulesToWebpageName = ImmutableMap.<String, String>builder()
    .put("__future__", "__future__")
    .put("__main__", "__main__")
    .put("_dummy_thread", "_dummy_thread")
    .put("_thread", "_thread")
    .put("abc", "abc")
    .put("aifc", "aifc")
    .put("argparse", "argparse")
    .put("array", "array")
    .put("ast", "ast")
    .put("asynchat", "asynchat")
    .put("asyncio", "asyncio")
    .put("asyncore", "asyncore")
    .put("atexit", "atexit")
    .put("audioop", "audioop")
    .put("base64", "base64")
    .put("bdb", "bdb")
    .put("binascii", "binascii")
    .put("binhex", "binhex")
    .put("bisect", "bisect")
    .put("builtins", "builtins")
    .put("bz2", "bz2")
    .put("calendar", "calendar")
    .put("cgi", "cgi")
    .put("cgitb", "cgitb")
    .put("chunk", "chunk")
    .put("cmath", "cmath")
    .put("cmd", "cmd")
    .put("code", "code")
    .put("codecs", "codecs")
    .put("codeop", "codeop")
    .put("collections", "collections")
    .put("collections.abc", "collections.abc")
    .put("colorsys", "colorsys")
    .put("compileall", "compileall")
    .put("concurrent.futures", "concurrent.futures")
    .put("configparser", "configparser")
    .put("contextlib", "contextlib")
    .put("contextvars", "contextvars")
    .put("copy", "copy")
    .put("copyreg", "copyreg")
    .put("crypt", "crypt")
    .put("csv", "csv")
    .put("ctypes", "ctypes")
    .put("curses", "curses")
    .put("curses.ascii", "curses.ascii")
    .put("curses.panel", "curses.panel")
    .put("datetime", "datetime")
    .put("dbm", "dbm")
    .put("decimal", "decimal")
    .put("difflib", "difflib")
    .put("dis", "dis")
    .put("distutils", "distutils")
    .put("doctest", "doctest")
    .put("dummy_threading", "dummy_threading")
    .put("email", "email")
    .put("email.charset", "email.charset")
    .put("email.contentmanager", "email.contentmanager")
    .put("email.encoders", "email.encoders")
    .put("email.errors", "email.errors")
    .put("email.generator", "email.generator")
    .put("email.header", "email.header")
    .put("email.headerregistry", "email.headerregistry")
    .put("email.iterators", "email.iterators")
    .put("email.message", "email.message")
    .put("email.message.Message", "email.compat32-message")
    .put("email.mime", "email.mime")
    .put("email.parser", "email.parser")
    .put("email.policy", "email.policy")
    .put("email.utils", "email.util")
    .put("ensurepip", "ensurepip")
    .put("enum", "enum")
    .put("errno", "errno")
    .put("faulthandler", "faulthandler")
    .put("fcntl", "fcntl")
    .put("filecmp", "filecmp")
    .put("fileinput", "fileinput")
    .put("fnmatch", "fnmatch")
    .put("formatter", "formatter")
    .put("fractions", "fractions")
    .put("ftplib", "ftplib")
    .put("functools", "functools")
    .put("gc", "gc")
    .put("getopt", "getopt")
    .put("getpass", "getpass")
    .put("gettext", "gettext")
    .put("glob", "glob")
    .put("grp", "grp")
    .put("gzip", "gzip")
    .put("hashlib", "hashlib")
    .put("heapq", "heapq")
    .put("hmac", "hmac")
    .put("html", "html")
    .put("html.entities", "html.entities")
    .put("html.parser", "html.parser")
    .put("http", "http")
    .put("http.client", "http.client")
    .put("http.cookiejar", "http.cookiejar")
    .put("http.cookies", "http.cookies")
    .put("http.server", "http.server")
    .put("imaplib", "imaplib")
    .put("imghdr", "imghdr")
    .put("imp", "imp")
    .put("importlib", "importlib")
    .put("inspect", "inspect")
    .put("io", "io")
    .put("ipaddress", "ipaddress")
    .put("itertools", "itertools")
    .put("json", "json")
    .put("keyword", "keyword")
    .put("linecache", "linecache")
    .put("locale", "locale")
    .put("logging", "logging")
    .put("logging.config", "logging.config")
    .put("logging.handlers", "logging.handlers")
    .put("lzma", "lzma")
    .put("macpath", "macpath")
    .put("mailbox", "mailbox")
    .put("mailcap", "mailcap")
    .put("marshal", "marshal")
    .put("math", "math")
    .put("mimetypes", "mimetypes")
    .put("mmap", "mmap")
    .put("modulefinder", "modulefinder")
    .put("msilib", "msilib")
    .put("msvcrt", "msvcrt")
    .put("multiprocessing", "multiprocessing")
    .put("netrc", "netrc")
    .put("nis", "nis")
    .put("nntplib", "nntplib")
    .put("numbers", "numbers")
    .put("operator", "operator")
    .put("optparse", "optparse")
    .put("os", "os")
    .put("os.path", "os.path")
    .put("ossaudiodev", "ossaudiodev")
    .put("parser", "parser")
    .put("pathlib", "pathlib")
    .put("pdb", "pdb")
    .put("pickle", "pickle")
    .put("pickletools", "pickletools")
    .put("pipes", "pipes")
    .put("pkgutil", "pkgutil")
    .put("platform", "platform")
    .put("plistlib", "plistlib")
    .put("poplib", "poplib")
    .put("posix", "posix")
    .put("pprint", "pprint")
    .put("pty", "pty")
    .put("pwd", "pwd")
    .put("py_compile", "py_compile")
    .put("pyclbr", "pyclbr")
    .put("pydoc", "pydoc")
    .put("queue", "queue")
    .put("quopri", "quopri")
    .put("random", "random")
    .put("re", "re")
    .put("readline", "readline")
    .put("reprlib", "reprlib")
    .put("resource", "resource")
    .put("rlcompleter", "rlcompleter")
    .put("runpy", "runpy")
    .put("sched", "sched")
    .put("secrets", "secrets")
    .put("select", "select")
    .put("selectors", "selectors")
    .put("shelve", "shelve")
    .put("shlex", "shlex")
    .put("shutil", "shutil")
    .put("signal", "signal")
    .put("site", "site")
    .put("smtpd", "smtpd")
    .put("smtplib", "smtplib")
    .put("sndhdr", "sndhdr")
    .put("socket", "socket")
    .put("socketserver", "socketserver")
    .put("spwd", "spwd")
    .put("sqlite3", "sqlite3")
    .put("ssl", "ssl")
    .put("stat", "stat")
    .put("statistics", "statistics")
    .put("string", "string")
    .put("stringprep", "stringprep")
    .put("struct", "struct")
    .put("subprocess", "subprocess")
    .put("sunau", "sunau")
    .put("symbol", "symbol")
    .put("symtable", "symtable")
    .put("sys", "sys")
    .put("sysconfig", "sysconfig")
    .put("syslog", "syslog")
    .put("tabnanny", "tabnanny")
    .put("tarfile", "tarfile")
    .put("telnetlib", "telnetlib")
    .put("tempfile", "tempfile")
    .put("termios", "termios")
    .put("test", "test")
    .put("textwrap", "textwrap")
    .put("threading", "threading")
    .put("time", "time")
    .put("timeit", "timeit")
    .put("tkinter", "tkinter")
    .put("tkinter.scrolledtext", "tkinter.scrolledtext")
    .put("tkinter.tix", "tkinter.tix")
    .put("tkinter.ttk", "tkinter.ttk")
    .put("token", "token")
    .put("tokenize", "tokenize")
    .put("trace", "trace")
    .put("traceback", "traceback")
    .put("tracemalloc", "tracemalloc")
    .put("tty", "tty")
    .put("turtle", "turtle")
    .put("types", "types")
    .put("typing", "typing")
    .put("unicodedata", "unicodedata")
    .put("unittest", "unittest")
    .put("unittest.mock", "unittest.mock")
    .put("urllib", "urllib")
    .put("urllib.error", "urllib.error")
    .put("urllib.parse", "urllib.parse")
    .put("urllib.request", "urllib.request")
    .put("urllib.robotparser", "urllib.robotparser")
    .put("uu", "uu")
    .put("uuid", "uuid")
    .put("venv", "venv")
    .put("warnings", "warnings")
    .put("wave", "wave")
    .put("weakref", "weakref")
    .put("webbrowser", "webbrowser")
    .put("winreg", "winreg")
    .put("winsound", "winsound")
    .put("wsgiref", "wsgiref")
    .put("xdrlib", "xdrlib")
    .put("xml.dom", "xml.dom")
    .put("xml.dom.minidom", "xml.dom.minidom")
    .put("xml.dom.pulldom", "xml.dom.pulldom")
    .put("xml.etree.ElementTree", "xml.etree.elementtree")
    .put("xml.parsers.expat", "pyexpat")
    .put("xml.sax", "xml.sax")
    .put("xml.sax.handler", "xml.sax.handler")
    .put("xml.sax.saxutils", "xml.sax.utils")
    .put("xml.sax.xmlreader", "xml.sax.reader")
    .put("xmlrpc", "xmlrpc")
    .put("xmlrpc.client", "xmlrpc.client")
    .put("xmlrpc.server", "xmlrpc.server")
    .put("zipapp", "zipapp")
    .put("zipfile", "zipfile")
    .put("zipimport", "zipimport")
    .put("zlib", "zlib")
    .build();

  @Override
  public String getExternalDocumentationUrl(PsiElement element, PsiElement originalElement) {
    if (PyBuiltinCache.getInstance(element).isBuiltin(element)) return null;
    PsiFileSystemItem file = element instanceof PsiFileSystemItem ? (PsiFileSystemItem) element : element.getContainingFile();
    if (PyNames.INIT_DOT_PY.equals(file.getName())) {
      file = file.getParent();
      assert file != null;
    }
    Sdk sdk = PyBuiltinCache.findSdkForFile(file);
    VirtualFile vFile = file.getVirtualFile();
    if (vFile != null && sdk != null && PythonSdkType.isStdLib(vFile, sdk)) {
      QualifiedName qName = QualifiedNameFinder.findCanonicalImportPath(element, originalElement);
      return getStdlibUrlFor(element, qName, sdk);
    }
    return null;
  }

  @Override
  public String getExternalDocumentationRoot(Sdk sdk) {
    final String versionString = sdk.getVersionString();
    if (versionString != null && StringUtil.startsWithIgnoreCase(versionString, "jython")) {
      return "http://jython.org/docs/library/";
    }
    final String pyVersion = PythonDocumentationProvider.pyVersion(versionString);
    StringBuilder urlBuilder = new StringBuilder("https://docs.python.org/");
    if (pyVersion != null) {
      urlBuilder.append(pyVersion).append("/");
    }
    if (pyVersion != null && (pyVersion.startsWith("2.4") || pyVersion.startsWith("2.5"))) {
      urlBuilder.append("lib/");
    }
    else {
      urlBuilder.append("library/");
    }
    return urlBuilder.toString();
  }

  private String getStdlibUrlFor(PsiElement element, QualifiedName moduleName, Sdk sdk) {
    StringBuilder urlBuilder = new StringBuilder(getExternalDocumentationRoot(sdk));
    String qnameString = moduleName.toString();
    if (qnameString.equals("ntpath") || qnameString.equals("posixpath")) {
      qnameString = "os.path";
    }
    else if (qnameString.equals("nt")) {
      qnameString = "os";
    }
    else if (qnameString.equals("cPickle")) {
      qnameString = "pickle";
    }
    else if (qnameString.equals("pyexpat")) {
      qnameString = "xml.parsers.expat";
    }

    final String pyVersion = PythonDocumentationProvider.pyVersion(sdk.getVersionString());
    final Map<String, String> moduleToWebpageName =
      pyVersion != null && pyVersion.startsWith("3") ? py3LibraryModulesToWebpageName : py2LibraryModulesToWebpageName;
    final String webpageName = moduleToWebpageName.get(qnameString);
    final boolean foundModule = webpageName != null;
    if (foundModule) {
      urlBuilder.append(webpageName + ".html");
    }

    if (foundModule && element instanceof PsiNamedElement && !(element instanceof PyFile)) {
      urlBuilder.append('#').append(moduleName).append(".");
      if (element instanceof PyFunction) {
        final PyClass containingClass = ((PyFunction)element).getContainingClass();
        if (containingClass != null) {
          urlBuilder.append(containingClass.getName()).append('.');
        }
      }
      urlBuilder.append(((PsiNamedElement)element).getName());
    }
    return urlBuilder.toString();
  }

}

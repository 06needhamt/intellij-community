@startuml
!include jb-plantuml-theme.puml

:getService;
note right
  In any thread.
  Get on demand only.
  Do not cache result.
  Do not request in constructor unless needed.
end note

' add link to docs about Light Service once https://github.com/JetBrains/intellij-sdk-docs/pull/242 will be merged
if (Is Light Service) then (yes)
else (no)
  if (Is Adapter Found) then (yes)
  else (no)
    :Return ""null"";
    detach
  endif
endif

if (Is Created and Initialized?) then (yes)
else (no)
  if (Is Container Active?) then (active)
    partition "synchronized on service" {
      if (Is Created and Initialized?) then (yes)
      else (no)
        if (Is Initializing?) then (yes)
          :Throw ""PluginException""
          Cyclic Service Initialization;
          detach
        else (no)
          partition "non cancelable" {
            :Create Instance]
            note right
              Avoid getting other services to reduce initialization tree.
              As less dependencies, as more faster and reliable.
            end note

            if (Implements ""Disposable"") then (yes)
              :Register to be disposed]
            else (no)
            endif
            if (Implements ""PersistentStateComponent"") then (yes)
              :Load Persistent State]
            else (no)
            endif
          }
        endif
      endif
    }
  else (disposed or dispose in progress)
    :Throw ""ProcessCanceledException"";
    detach
  endif
endif

:Return Instance;

@enduml